databaseChangeLog:
  - changeSet:
      id: create_task_table
      author: sqy
      changes:
        - createTable:
            tableName: task
            columns:
              - column:
                  name: task_id
                  type: serial
                  constraints:
                    primaryKey: true
              - column:
                  name: name
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: text
              - column:
                  name: performer_id
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: estimated_hours
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: deadline
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: author_id
                  type: int
                  constraints:
                    nullable: false
              - column:
                  name: related_file
                  type: bytea
              - column:
                  name: creation_date
                  type: timestamp
              - column:
                  name: last_update_date
                  type: timestamp
            foreignKeys:
              - foreignKey:
                  name: fk_task_performer_id
                  referencedTableName: employee
                  referencedColumnNames: employee_id
                  onDelete: cascade
              - foreignKey:
                  name: fk_task_author_id
                  referencedTableName: project_member
                  referencedColumnNames: project_member_id
                  onDelete: cascade

  # https://github.com/liquibase/liquibase/issues/1094, нельзя проставить дефолтное значение через defaultValue
  - changeSet:
      id: add_default_values_to_creation_date_and_last_update_date
      author: sqy
      changes:
        - sql:
            sql: >
              ALTER TABLE task
              ALTER COLUMN last_update_date SET DEFAULT current_timestamp,
              ALTER COLUMN creation_date SET DEFAULT current_timestamp;

  - changeSet:
      id: create_last_modified_function
      author: sqy
      changes:
        - sql:
            sql: >
              CREATE OR REPLACE FUNCTION update_last_modified()
              RETURNS TRIGGER AS
              '
              BEGIN
                NEW.last_update_date = NOW();
                RETURN NEW;
              END;
              ' LANGUAGE plpgsql;

  - changeSet:
      id: create_trigger_for_task_table
      author: sqy
      changes:
        - sql:
            sql: >
              CREATE TRIGGER task_last_modified
              BEFORE UPDATE
              ON task
              FOR EACH ROW
              EXECUTE FUNCTION update_last_modified();